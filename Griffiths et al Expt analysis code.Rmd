---
title: "Griffiths et al experiment analysis"
author: "Mary OConnor"
date: '2019-09-13'
output: pdf_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(dplyr)
library(reshape2)
library(plyr)
library(stringr)
#library(nlme)
library(MuMIn)
library(knitr)
library(captioner)
knitr::opts_chunk$set(echo = FALSE)
```

```{r, echo=FALSE}
## load data
smith.bio <- read.csv("./data/Smith.csv") # from experiment
compare <- read.csv("./data/choked_seagrass_smithora.csv")
sites <- read.csv("./data/choked_sites.csv")
smith.expt <- read.csv("./data/Transplant_raw_smithora_wt.csv")
grazertraits <- read.csv("./data/grazertraitsmaster.csv")
grazers <- read.csv("./data/Grazers_EdgeVSInterior_V1_Aug09_2017.csv")
```

```{r}
### compare
## from meadow surveys, identify edge and inner samples
edge <- filter(compare, site == "choked_edge_wolf")
inner <- filter(compare, site == "choked_inner_wolf")
compare_edge <- bind_rows(inner,edge)

###Making data nicer for plotting
#head(compare)
#View(compare)
compare_edge2 <- compare_edge
compare_edge2$site <- as.character(compare_edge2$site)
compare_edge2$site[compare_edge$site == "choked_edge_wolf"] <- "Edge"
compare_edge2$site <- as.character(compare_edge2$site)
compare_edge2$site[compare_edge$site == "choked_inner_wolf"] <- "Interior"

## function to estimate sds for boxplots
min.mean.sd.max <- function(x) {
  r <- c(min(x), mean(x) - sd(x), mean(x), mean(x) + sd(x), max(x))
  names(r) <- c("ymin", "lower", "middle", "upper", "ymax")
  r
}
```

## survey results for Z density
A) Shoot density (moved to supplementary material)
```{r}
hist(compare_edge2$number.shoots.quadrat)
mod1 <- lm(number.shoots.quadrat ~ 1 + site, data = compare_edge2)
mod0 <- lm(number.shoots.quadrat ~ 1, data = compare_edge2)
anova(mod0, mod1)
```

```{r}
shoot.density <- ggplot(compare_edge2, aes(x = site, y = number.shoots.quadrat)) + 
  geom_point(size = 6, colour = "gray") +
  geom_boxplot(size = 1, fill = "transparent") + 
  scale_y_continuous(name = "Zostera Shoots (N/0.0625 m^2)", labels=c("0","5","10","15"), limits = c(0, 15)) +
  theme_bw() + 
  theme(panel.grid = element_blank()) + 
  xlab(expression("Location")) + 
  geom_text(label = "A", x = 2.4, y = 15) +
  theme(axis.title.x = element_text(vjust = -1, size = 12)) + 
  theme(axis.title.y = element_text(vjust = -1, size = 12))

shoot.density

ggsave("shoot.density.jpg", plot = shoot.density, width = 3, height = 3)
```

## survey results for invertebrate density
```{r}

```


FIGURE 2: ZOSTERA, SMITHORA and GRAZER ABUNDANCE at transplant sites before experiment


#Analysis

A) Zostera shoot dry weight
```{r}
shoot.dwt <- ggplot(compare_edge2, aes(x = site, y = total.dry.macro.weight)) + 
  geom_jitter(position = position_jitter(width=.2), size=3, colour = "gray60") +
  stat_summary(fun.data = min.mean.sd.max, geom = "boxplot", fill = "transparent") + 
  scale_y_continuous(name = "Zostera shoot dry weight (g)", labels=c("0","10","20", "30"), limits = c(0, 30)) +
  theme_bw() + 
  theme(panel.grid = element_blank()) + 
  xlab(expression("Location")) + 
  geom_text(label = "A", x = 2.4, y = 30) +
  theme(axis.title.x = element_text(vjust = -1, size = 12)) + 
  theme(axis.title.y = element_text(vjust = -1, size = 12))

shoot.dwt
ggsave("shoot.dwt.jpg", plot = shoot.dwt, width = 3, height = 3)
```

Zostera above ground dry weight
```{r}
#hist(compare_edge2$total.dry.macro.weight)
mod1 <- lm(total.dry.macro.weight ~ site, data = compare_edge2)
anova(mod1)
summary(mod1)
coef(mod1)[1]*16
(coef(mod1)[1]+coef(mod1)[2])*16
(confint(mod1)[1,])*16
(coef(mod1)[1]+confint(mod1)[2,1])*16
(coef(mod1)[1]+confint(mod1)[2,2])*16
```

B) Smithora load (dry weight)
```{r}
#hist(compare_edge2$total.dry.macro.weight)
mod1 <- lm((macroepiphyte.weight/total.dry.macro.weight) ~ site, data = compare_edge2)
anova(mod1)
```

```{r}
smithora <- ggplot(compare_edge2, aes(x = site, y = macroepiphyte.weight/total.dry.macro.weight)) + 
  geom_jitter(position = position_jitter(width=.2), size=3, colour = "gray60") +
  stat_summary(fun.data = min.mean.sd.max, geom = "boxplot", fill = "transparent") + 
  scale_y_continuous(name = expression(paste(italic("Smithora"), " (g dry wt / g Zostera dry wt)")), limits = c(0, 0.5)) +
  theme_bw() + 
  theme(panel.grid = element_blank()) + 
  xlab(expression("Location")) + 
  geom_text(label = "B", x = 2.4, y = 0.5) +
  theme(axis.title.x = element_text(vjust = -1, size = 12)) + 
  theme(axis.title.y = element_text(vjust = -1, size = 12))

smithora

ggsave("smithora.jpg", plot = smithora, width = 3, height = 3)
```

D) GRAZER ABUNDANCE -- placeholder, waiting for final plot labels from Gwen

```{r} 
#issues here: are these from two sample dates, and if so, which is which?
# also, track down the plot labels which would indicate... what?
grazers[is.na(grazers)] <- 0
grazers1 <- melt(grazers, id = c(1,2,3,4))
grazers1 <- grazers1 %>%
  filter(Site != "")
names(grazers1) <- c("Site", "Source", "Plot", "Size", "Species", "Abundance")
grazers2 <- grazers1 %>%
  filter(Site != "0")
grazers3 <- ddply(grazers2, .(Site, Source, Plot, Species), summarise, sum(Abundance))
grazers3$N <- grazers3[,5]
grazers3 <- grazers3[,-5]
grazers4 <- grazers3 %>%
  filter(Species != "byozoan 1cm") %>%
  filter(Species != "NA") %>%
  filter(Species != "stalked jelly") %>%
  filter(Species != "flat worm") %>%
  filter(Species != "anemone") %>%
  filter(Species != "fruit loop") %>%
  filter(Species != "Dungeness") %>%
  filter(Plot != "ASU") 
names(grazers4) <- c("Site", "Source", "Plot", "Species", "Abundance")
grazers5 <- ddply(grazers4, .(Site, Source, Plot), summarise, sum(Abundance))
names(grazers5) <- c("Site", "Source", "Plot","Abundance")

grazerfig <- ggplot(grazers5, aes(x = Source, y = Abundance)) + 
  geom_jitter(position = position_jitter(width=.2), size=3, colour = "gray60") +
  stat_summary(fun.data = min.mean.sd.max, geom = "boxplot", fill = "transparent") + 
  scale_y_continuous(name = "Epifaunal Grazer Density (N / XX)") + #limits = c(0, 0.5)
  theme_bw() + 
  theme(panel.grid = element_blank()) + 
  xlab(expression("Location")) + 
  geom_text(label = "C", x = 2.4, y = 650) +
  theme(axis.title.x = element_text(vjust = -1, size = 12)) + 
  theme(axis.title.y = element_text(vjust = -1, size = 12))

grazerfig
ggsave("grazerfig.jpg", plot = grazers, width = 3, height = 3)

## now once we know the treatments for each plot, we can plot total abundance
```

FIGURE 3: Smithora results post experiment - remake this figure. april 5th: i'm not if it still needs to be remade - i have to check this.
```{r}
#head(smith.expt)
smith.expt$Source <- revalue(smith.expt$Source, c("Edge"="Edge (high Smithora)",  "Interior"="Interior (low Smithora)"))
smith.expt$Source <- as.factor(smith.expt$Source)
smith.expt$Type <- revalue(smith.expt$Category.in.transplant, c("Ambient"="Unmanip.", "Experiment"="Transplanted", "Control"="Control"))
smith.expt$Type <- as.factor(smith.expt$Type)
smith.expt$ratio <- smith.expt$Ratio.smithora.leaves

experiment <- ggplot(smith.expt[(smith.expt$Type != "Unmanip."),], aes(x = Type, y = ratio)) + 
geom_jitter(position = position_jitter(width=.2), size=3, colour = "gray60") +
stat_summary(fun.data = min.mean.sd.max, geom = "boxplot", fill = "transparent") + 
facet_wrap(~Source) + 
theme_bw() + 
theme(panel.grid = element_blank()) + 
theme(strip.background = element_rect(fill="white")) + 
scale_y_continuous(name = expression(paste(italic("Smithora"), " (g dry wt / g Zostera dry wt)")), limits = c(-0.1, 1), breaks = c(0, 0.5, 1), labels = c(0, 0.5, 1)) +
xlab("") +
labs(title = "Site of Experimental Planting") 

experiment
ggsave("experiment.jpg", plot = experiment, width = 6, height = 3)
```

Experimental analysis: 

first analyze control vs unmanipulated
```{r}
hist((smith.expt[(smith.expt$Type != "Transplanted"),]$ratio))
mod1 <- lm((smith.expt[(smith.expt$Type != "Transplanted"),]$ratio) ~ smith.expt[(smith.expt$Type != "Transplanted"),]$Type + smith.expt[(smith.expt$Type != "Transplanted"),]$Source)
anova(mod1)
```

then analyze control v transplanted
```{r}
hist(log(smith.expt[(smith.expt$Type != "Unmanip."),]$ratio + 1))
mod2 <- lm(log(smith.expt[(smith.expt$Type != "Unmanip."),]$ratio + 1) ~ smith.expt[(smith.expt$Type != "Unmanip."),]$Type * smith.expt[(smith.expt$Type != "Unmanip."),]$Source)
anova(mod2)
```
